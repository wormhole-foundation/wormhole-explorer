import { evmProposalCreatedMapper } from "../../../../src/infrastructure/mappers/evm/evmProposalCreatedMapper";
import { HandleEvmTransactions } from "../../../../src/domain/actions";
import { describe, it, expect } from "@jest/globals";

let statsRepo = {
  count: () => {},
  measure: () => {},
  report: () => Promise.resolve(""),
};

const handler = new HandleEvmTransactions(
  {
    abis: [
      {
        abi: "event ProposalCreated(uint256 proposalId, address proposer,address[] targets, uint256[] values, string[] signatures, bytes[] calldatas,uint256 voteStart, uint256 voteEnd, string description)",
        topic: "0x7d84a6263ae0d98d3329bd7b46bb4e8d6f98cd35a7adb45c274c8b7fd5ebd5e0",
      },
    ],
    environment: "testnet",
    metricName: "process_proposal_created_event",
    commitment: "finalized",
    chainId: 10002,
    chain: "ethereum-sepolia",
    id: "poll-log-proposal-created-ethereum-sepolia-finalized",
  },
  evmProposalCreatedMapper,
  async () => {},
  statsRepo
);

describe("evmProposalCreatedMapper", () => {
  it("should be able to map log to evmProposalCreatedMapper with proposal information", async () => {
    // When
    const [result] = await handler.handle([
      {
        blockHash: "0x6c9f36d9f255ae50a0d351d892239b20f43c03809654913f818902fce4258ae1",
        blockNumber: 0x6205a0n,
        from: "0xba78c48c386a5c43f689af7c8feb77207aca8477",
        gas: "0x17821",
        gasPrice: "0x118078836",
        maxPriorityFeePerGas: "0x59682f00",
        maxFeePerGas: "0x7aef40a00",
        hash: "0xf7f0ad2be72df41be9f0e4511f6a77b0656089b4147d71a9c50930a56d889cf0",
        input:
          "0x7d5e81e2000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ba78c48c386a5c43f689af7c8feb77207aca847700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d23207465737437340a7465737400000000000000000000000000000000000000",
        nonce: "0x11e",
        to: "0x22be15e73da369066576e103d1c0e9c3ad1386a5",
        transactionIndex: "0x12",
        value: "0x0",
        type: "0x2",
        chainId: 10002,
        v: "0x0",
        r: "0x9c3d44acd46e3db5823a69827607d4e0a9159f5bf6b9b29c32f4b22304ba9c75",
        s: "0x3902fe5b3916c0553d90f4c7e300fdd902eaab51afb604a759335f9099852096",
        effectiveGasPrice: "0x118078836",
        gasUsed: "0x17460",
        timestamp: 1722619812,
        status: "0x1",
        logs: [
          {
            address: "0x22be15e73da369066576e103d1c0e9c3ad1386a5",
            topics: ["0x7d84a6263ae0d98d3329bd7b46bb4e8d6f98cd35a7adb45c274c8b7fd5ebd5e0"],
            data: "0x4ba89ff8bc07c109f576e6cd8d89416431b04d3a377918b5f979b37f9e994d1f000000000000000000000000ba78c48c386a5c43f689af7c8feb77207aca84770000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000066ad17fe0000000000000000000000000000000000000000000000000000000066ad1f0600000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ba78c48c386a5c43f689af7c8feb77207aca847700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d23207465737437340a7465737400000000000000000000000000000000000000",
          },
        ],
        environment: "testnet",
        chain: "ethereum-sepolia",
      },
    ]);

    // Then
    expect(result?.name).toBe("proposal-created");
    expect(result?.chainId).toBe(10002);
    expect(result?.blockHeight).toBe(6423968n);
    expect(result?.blockTime).toBe(1722619812);
    expect(result?.txHash).toBe(
      "0xf7f0ad2be72df41be9f0e4511f6a77b0656089b4147d71a9c50930a56d889cf0"
    );
    expect(result?.attributes.description).toBe("# test74\ntest");
    expect(result?.attributes.calldatas).toEqual(["0x"]);
    expect(result?.attributes.targets).toEqual(["0xBa78C48C386a5c43F689af7c8FEB77207aCa8477"]);
    expect(result?.attributes.voteStart).toEqual(1722619902);
    expect(result?.attributes.voteEnd).toEqual(1722621702);
    expect(result?.attributes.signatures).toEqual([""]);
    expect(result?.attributes.proposer).toEqual("0xBa78C48C386a5c43F689af7c8FEB77207aCa8477");
    expect(result?.attributes.proposalId).toEqual(
      34221398034165561516589469039816796864932763323281094730950106591996231109919n
    );
  });
});
